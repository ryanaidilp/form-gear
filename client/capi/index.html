<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000" />

  <title>FormGear</title>
  <style>

    /*style*/

  </style>
  <!-- <link rel="stylesheet" href="https://unpkg.com/form-gear/dist/style.css"> -->
  <link rel="stylesheet" href="./data/style.css">
</head>

<body>
<noscript>You need to enable JavaScript to run this app.</noscript>

<div id="FormGear-loader" class="bg-gray-200  dark:bg-[#181f30] h-screen">

  <div class="overflow-hidden">
    <div class="bg-gray-50 dark:bg-gray-900 dark:text-white h-screen shadow-xl text-gray-600 flex overflow-hidden text-sm font-montserrat rounded-lg  dark:shadow-gray-800">
      
      
      <div class=" flex-grow flex flex-col bg-white dark:bg-gray-900 z-0">

        <div class="relative  md:flex max-h-screen  ">            
          <div class="block">
            <div class=" backdrop-blur-sm col-span-12 overflow-x-hidden overflow-y-auto fixed inset-0 z-50 outline-none focus:outline-none flex justify-center items-center">
              <svg class="w-20 h-20 animate-spin" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 94.53 98.372"><circle cx="23.536" cy="16.331" r="8.646" style="fill:#0a77e8"/><circle cx="8.646" cy="36.698" r="8.646" style="fill:#0f9af0"/><circle cx="8.646" cy="61.867" r="8.646" style="fill:#0f9af0"/><circle cx="23.536" cy="82.233" r="8.646" style="fill:#13bdf7"/><circle cx="47.361" cy="89.726" r="8.646" style="fill:#13bdf7"/><circle cx="71.282" cy="82.233" r="8.646" style="fill:#18e0ff"/><circle cx="85.884" cy="61.867" r="8.646" style="fill:#65eaff"/><circle cx="85.884" cy="36.698" r="8.646" style="fill:#b2f5ff"/><circle cx="47.361" cy="8.646" r="8.646" style="fill:#1d4970"/></svg>
            </div>
          </div>

          <div
            class="bg-gray-50 dark:bg-gray-900 w-72 flex-shrink-0  dark:border-gray-800 h-full  p-5 space-y-4
            absolute inset-y-0 left-0 transform -translate-x-full transition-transform duration-500 ease-in-out md:relative md:translate-x-0 z-10">

            <div class="animate-pulse flex space-x-4">
              <div class="flex-1 space-y-3 py-1">
                <div class="w-full  shadow-2xl rounded-lg">

                  <div class="h-32 bg-gray-200 rounded-tr-lg rounded-tl-lg animate-pulse"></div>

                  <div class="p-5">
                    <div class="h-20 px-2 rounded-lg bg-gray-200 animate-pulse mb-4"></div>
                    <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                    <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
                    <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>

                    <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                    <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
                    <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>

                    <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                    <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
                    <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>

                    <div class="h-20 px-2 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                  </div>

                </div>
              </div>
            </div>

          </div>

          <div class="flex-grow bg-white dark:bg-gray-900 transition duration-500 ease-in-out z-10 p-5 space-y-4
            ">

            <div class="flex-grow bg-white dark:bg-gray-900 ">
              <div class=" w-full mx-auto">
                <div class="animate-pulse flex space-x-4">
                  <div class="flex-1 space-y-3 py-1">
                    <div
                      class="min-h-screen flex items-start justify-start bg-gradient-to-br from-gray-200 to-gray-400">
          
                      <div class="w-full bg-white  shadow-2xl rounded-lg">

                        <div class="h-32 bg-gray-200 rounded-tr-lg rounded-tl-lg animate-pulse"></div>

                        <div class="p-5">
                          <div class="h-20 px-2 rounded-lg bg-gray-200 animate-pulse mb-4"></div>
                          <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                          <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
                          <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>

                          <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                          <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
                          <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>

                          <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                          <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
                          <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>

                          <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                          <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
                        </div>

                      </div>

                    </div>

                  </div>
                </div>
              </div>
            </div>

          </div>



        </div>

      </div>
    </div>
  </div>

</div>


<div id="FormGear-root"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script type="module">
  /**
   * FormGear 2.0 CAPI Client Example
   * Supports: Android, iOS, Flutter WebViews
   */
  import {
    createFormGear,
    createBridge,
    detectPlatform,
    ClientMode,
    FormMode,
    InitialMode,
    LookupMode
  } from './data/form-gear.es.js'

  // Detect platform
  const platformInfo = detectPlatform();
  console.log(`Platform: ${platformInfo.platform} (${platformInfo.confidence})`);

  // Create native bridge for platform communication
  const bridge = createBridge({ debug: true });

  // Form state variables
  let formInstance = null;
  let responseGear = null;
  let mediaGear = null;
  let remarkGear = null;
  let principalGear = null;
  let referenceGear = null;

  // =============================================================================
  // PLATFORM-AGNOSTIC HANDLERS
  // =============================================================================

  /**
   * Upload handler - works across Android, iOS, Flutter
   */
  const uploadHandler = (setValue) => {
    console.log('Upload handler triggered');
    window.cameraFunction = setValue;

    // Use bridge for platform-agnostic camera access
    bridge.openCamera()
      .then(result => {
        if (result && setValue) {
          setValue(result);
        }
      })
      .catch(err => console.error('Camera error:', err));
  };

  /**
   * GPS handler - works across Android, iOS, Flutter
   */
  const gpsHandler = (setter, needPhoto = false) => {
    console.log('GPS handler triggered, needPhoto:', needPhoto);
    window.cameraGPSFunction = setter;

    bridge.openCameraWithGps(needPhoto)
      .then(result => {
        if (result && setter) {
          setter(result, result.remark);
        }
      })
      .catch(err => console.error('GPS error:', err));
  };

  /**
   * Offline search handler
   */
  const offlineSearch = (id, version, dataJson, setter) => {
    console.log('Offline search:', id, version);
    const condition = JSON.stringify(dataJson);

    // Try native bridge first (for SQLite lookups on mobile)
    if (bridge.platform !== 'web') {
      bridge.searchOffline(id, version, dataJson)
        .then(result => setter(result))
        .catch(err => {
          console.error('Native search failed, falling back to HTTP:', err);
          // Fallback to HTTP
          fetchOfflineData(id, version, condition, setter);
        });
    } else {
      fetchOfflineData(id, version, condition, setter);
    }
  };

  /**
   * HTTP fallback for offline search
   */
  const fetchOfflineData = (id, version, condition, setter) => {
    fetch(`http://localhost:9090/lookup?id=${id}&v=${version}&c=${condition}`)
      .then(res => res.json())
      .then(data => {
        console.log('Lookup result:', data);
        setter(data);
      })
      .catch(err => console.error('Lookup error:', err));
  };

  /**
   * Online search handler
   */
  const onlineSearch = async (url) => {
    try {
      const res = await fetch(url, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });

      if (res.ok) {
        return await res.json();
      } else {
        return { success: false, data: {}, message: res.status };
      }
    } catch (error) {
      return { success: false, data: {}, message: '500' };
    }
  };

  /**
   * Exit handler - works across Android, iOS, Flutter
   */
  const exitHandler = (callback) => {
    bridge.exit();
    if (callback) callback();
  };

  /**
   * Open map handler - works across Android, iOS, Flutter
   */
  const openMap = (koordinat) => {
    bridge.openMap(koordinat);
  };

  /**
   * Save response handler - works across Android, iOS, Flutter
   */
  const onSave = (res, med, rem, princ, ref) => {
    responseGear = res;
    mediaGear = med;
    remarkGear = rem;
    principalGear = princ;
    referenceGear = ref;

    console.log('----------', new Date(), '----------');
    console.log('Save - response:', responseGear);
    console.log('Save - media:', mediaGear);
    console.log('Save - remark:', remarkGear);
    console.log('Save - principal:', principalGear);
    console.log('Save - reference:', referenceGear);

    // Use bridge to save (works on all platforms)
    bridge.saveResponse({
      response: responseGear,
      media: mediaGear,
      remark: remarkGear,
      principal: principalGear,
      reference: referenceGear
    });
  };

  /**
   * Submit response handler - works across Android, iOS, Flutter
   */
  const onSubmit = (res, med, rem, princ, ref) => {
    responseGear = res;
    mediaGear = med;
    remarkGear = rem;
    principalGear = princ;
    referenceGear = ref;

    console.log('----------', new Date(), '----------');
    console.log('Submit - response:', responseGear);
    console.log('Submit - media:', mediaGear);
    console.log('Submit - remark:', remarkGear);
    console.log('Submit - principal:', principalGear);
    console.log('Submit - reference:', referenceGear);

    // Use bridge to submit (works on all platforms)
    bridge.submitResponse({
      response: responseGear,
      media: mediaGear,
      remark: remarkGear,
      principal: principalGear,
      reference: referenceGear
    });
  };

  // =============================================================================
  // FORM INITIALIZATION
  // =============================================================================

  const loadFormData = async () => {
    const [reference, template, preset, response, validation, media, remark] = await Promise.all([
      fetch('./data/reference.json').then(res => res.json()).catch(() => ({})),
      fetch('./data/template.json').then(res => res.json()).catch(() => ({})),
      fetch('./data/preset.json').then(res => res.json()).catch(() => ({})),
      fetch('./data/response.json').then(res => res.json()).catch(() => ({})),
      fetch('./data/validation.json').then(res => res.json()).catch(() => ({})),
      fetch('./data/media.json').then(res => res.json()).catch(() => ({})),
      fetch('./data/remark.json').then(res => res.json()).catch(() => ({}))
    ]);

    return { reference, template, preset, response, validation, media, remark };
  };

  const initForm = async () => {
    const { reference, template, preset, response, validation, media, remark } = await loadFormData();

    // Create form using new API
    formInstance = createFormGear({
      data: {
        reference,
        template,
        preset,
        response,
        validation,
        media,
        remark
      },
      config: {
        clientMode: ClientMode.CAPI,
        formMode: FormMode.OPEN,
        initialMode: InitialMode.ASSIGN,
        lookupMode: LookupMode.OFFLINE,
        username: 'styd',
        token: '',
        baseUrl: '',
        lookupKey: 'keys',
        lookupValue: 'values'
      },
      mobileHandlers: {
        uploadHandler,
        gpsHandler,
        offlineSearch,
        onlineSearch,
        exitHandler,
        openMap
      },
      callbacks: {
        onSave,
        onSubmit
      }
    });

    console.log('FormGear 2.0 initialized on platform:', bridge.platform);

    // Expose form instance globally for debugging
    window.formGear = formInstance;
  };

  // Initialize form
  initForm();

</script>

<script type="text/javascript">
  /**
   * Native callback handlers for all platforms
   * These functions are called by native code (Android, iOS, Flutter)
   */
  let cameraFunction = null;
  let cameraGPSFunction = null;

  /**
   * Universal result handler - called by native platforms
   * Android: window.result(action, result, customData)
   * iOS: window.webkit.messageHandlers posts back here
   * Flutter: window.postMessage or direct call
   */
  function result(action, result, customData) {
    console.log('Native callback:', action, result);

    switch(action) {
      case "GET_LOC":
        resultGps(result);
        break;
      case "CAMERA":
        resultCamera(result);
        break;
      case "CAMERA_GPS":
        resultCameraGPS(result);
        break;
      case "SIGNATURE":
        resultSignature(result);
        break;
      case "BARCODE":
        resultBarcode(result);
        break;
      case "AUDIO":
        resultAudio(result);
        break;
      case "GET_ANSWER":
      case "LOOKUP":
        resultAnswer(result, customData);
        break;
      default:
        console.log('Unknown action:', action);
    }
  }

  function resultCamera(result) {
    if (cameraFunction != null) {
      cameraFunction(result);
    } else {
      console.log('camera_result_function: null');
    }
  }

  function resultCameraGPS(result) {
    try {
      const obj = typeof result === 'string' ? JSON.parse(result) : result;
      const remark = obj.remark || '';
      if (cameraGPSFunction) {
        cameraGPSFunction(obj, remark);
      }
    } catch (e) {
      console.error('Error parsing GPS result:', e);
    }
  }

  function resultGps(result) {
    console.log('GPS result:', result);
  }

  function resultSignature(result) {
    console.log('Signature result:', result);
  }

  function resultBarcode(result) {
    console.log('Barcode result:', result);
  }

  function resultAudio(result) {
    console.log('Audio result:', result);
  }

  function resultAnswer(result, customData) {
    console.log('Answer result:', result, customData);
  }

  // =============================================================================
  // iOS WKWebView Message Handler
  // =============================================================================
  window.handleIOSMessage = function(message) {
    if (message && message.action) {
      result(message.action, message.data, message.customData);
    }
  };

  // =============================================================================
  // Flutter Message Handler
  // =============================================================================
  window.addEventListener('message', function(event) {
    try {
      const message = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
      if (message && message.action) {
        result(message.action, message.data, message.customData);
      }
    } catch (e) {
      // Not a FormGear message
    }
  });

</script>

</body>

</html>