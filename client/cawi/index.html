<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000" />

  <title>FormGear</title>

  <!-- <link rel="stylesheet" href="https://unpkg.com/form-gear/dist/style.css"> -->
  <link rel="stylesheet" href="./data/style.css">
</head>

<body>
  <noscript>You need to enable JavaScript to run this app.</noscript>
  
  <div id="FormGear-loader" class="bg-gray-200  dark:bg-[#181f30] h-screen">

    <div class="overflow-hidden">
      <div class="bg-gray-50 dark:bg-gray-900 dark:text-white h-screen shadow-xl text-gray-600 flex overflow-hidden text-sm font-montserrat rounded-lg  dark:shadow-gray-800">
        
        
        <div class=" flex-grow flex flex-col bg-white dark:bg-gray-900 z-0">
  
          <div class="relative  md:flex max-h-screen  ">            
            <div class="block">
              <div class=" backdrop-blur-sm col-span-12 overflow-x-hidden overflow-y-auto fixed inset-0 z-50 outline-none focus:outline-none flex justify-center items-center">
                <svg class="w-20 h-20 animate-spin" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 94.53 98.372"><circle cx="23.536" cy="16.331" r="8.646" style="fill:#0a77e8"/><circle cx="8.646" cy="36.698" r="8.646" style="fill:#0f9af0"/><circle cx="8.646" cy="61.867" r="8.646" style="fill:#0f9af0"/><circle cx="23.536" cy="82.233" r="8.646" style="fill:#13bdf7"/><circle cx="47.361" cy="89.726" r="8.646" style="fill:#13bdf7"/><circle cx="71.282" cy="82.233" r="8.646" style="fill:#18e0ff"/><circle cx="85.884" cy="61.867" r="8.646" style="fill:#65eaff"/><circle cx="85.884" cy="36.698" r="8.646" style="fill:#b2f5ff"/><circle cx="47.361" cy="8.646" r="8.646" style="fill:#1d4970"/></svg>
              </div>
            </div>
  
            <div
              class="bg-gray-50 dark:bg-gray-900 w-72 flex-shrink-0  dark:border-gray-800 h-full  p-5 space-y-4
              absolute inset-y-0 left-0 transform -translate-x-full transition-transform duration-500 ease-in-out md:relative md:translate-x-0 z-10">
  
              <div class="animate-pulse flex space-x-4">
                <div class="flex-1 space-y-3 py-1">
                  <div class="w-full  shadow-2xl rounded-lg">
  
                    <div class="h-32 bg-gray-200 rounded-tr-lg rounded-tl-lg animate-pulse"></div>
  
                    <div class="p-5">
                      <div class="h-20 px-2 rounded-lg bg-gray-200 animate-pulse mb-4"></div>
                      <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                      <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
                      <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
  
                      <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                      <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
                      <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
  
                      <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                      <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
                      <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
  
                      <div class="h-20 px-2 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                    </div>
  
                  </div>
                </div>
              </div>
  
            </div>
  
            <div class="flex-grow bg-white dark:bg-gray-900 transition duration-500 ease-in-out z-10 p-5 space-y-4
              ">
  
              <div class="flex-grow bg-white dark:bg-gray-900 ">
                <div class=" w-full mx-auto">
                  <div class="animate-pulse flex space-x-4">
                    <div class="flex-1 space-y-3 py-1">
                      <div
                        class="min-h-screen flex items-start justify-start bg-gradient-to-br from-gray-200 to-gray-400">
            
                        <div class="w-full bg-white  shadow-2xl rounded-lg">
  
                          <div class="h-32 bg-gray-200 rounded-tr-lg rounded-tl-lg animate-pulse"></div>
  
                          <div class="p-5">
                            <div class="h-20 px-2 rounded-lg bg-gray-200 animate-pulse mb-4"></div>
                            <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                            <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
                            <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
  
                            <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                            <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
                            <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
  
                            <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                            <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
                            <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
  
                            <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-10 mb-4"></div>
                            <div class="h-6 rounded-lg bg-gray-200 animate-pulse mt-4 mb-4"></div>
                          </div>
  
                        </div>
  
                      </div>
  
                    </div>
                  </div>
                </div>
              </div>
  
            </div>
  
  
  
          </div>
  
        </div>
      </div>
    </div>
  
  </div>
  
  <div id="FormGear-root"></div>

  <script type="module">
    /**
     * FormGear 2.0 CAWI Client Example
     * Web-based form (Computer-Assisted Web Interviewing)
     */
    import {
      createFormGear,
      ClientMode,
      FormMode,
      InitialMode,
      LookupMode
    } from './data/form-gear.es.js'

    // Form state variables
    let formInstance = null;
    let responseGear = null;
    let mediaGear = null;
    let remarkGear = null;
    let principalGear = null;
    let referenceGear = null;

    // =============================================================================
    // WEB HANDLERS (CAWI Mode)
    // =============================================================================

    /**
     * Upload handler - uses HTML5 file input
     */
    const uploadHandler = (setValue) => {
      console.log('Web upload handler triggered');

      // Create hidden file input
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';

      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            setValue(event.target.result);
          };
          reader.readAsDataURL(file);
        }
      };

      input.click();
    };

    /**
     * GPS handler - uses HTML5 Geolocation API
     */
    const gpsHandler = (setter, needPhoto = false) => {
      console.log('Web GPS handler triggered');

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const result = {
              coordinat: {
                lat: position.coords.latitude,
                long: position.coords.longitude
              },
              latitude: position.coords.latitude,
              longitude: position.coords.longitude,
              accuracy: position.coords.accuracy,
              remark: `Accuracy: ${position.coords.accuracy.toFixed(2)}m`
            };
            setter(result, result.remark);
          },
          (error) => {
            console.error('Geolocation error:', error);
            // Mock data for testing
            const mockResult = {
              coordinat: { long: 106.8924928, lat: -6.2488576 },
              latitude: -6.2488576,
              longitude: 106.8924928,
              accuracy: 17.88,
              remark: 'Accuracy within acceptable range (mock data)'
            };
            setter(mockResult, mockResult.remark);
          }
        );
      } else {
        console.error('Geolocation not supported');
      }
    };

    /**
     * Offline search handler - uses fetch API
     */
    const offlineSearch = (id, version, dataJson, setter) => {
      console.log('Offline search:', id, version);
      const condition = JSON.stringify(dataJson);

      fetch(`http://localhost:9090/lookup?id=${id}&v=${version}&c=${condition}`)
        .then(res => res.json())
        .then(data => {
          console.log('Lookup result:', data);
          setter(data);
        })
        .catch(err => console.error('Lookup error:', err));
    };

    /**
     * Online search handler
     */
    const onlineSearch = async (url) => {
      try {
        const res = await fetch(url, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (res.ok) {
          return await res.json();
        } else {
          return { success: false, data: {}, message: res.status };
        }
      } catch (error) {
        return { success: false, data: {}, message: '500' };
      }
    };

    /**
     * Exit handler - no-op for web
     */
    const exitHandler = (callback) => {
      if (callback) callback();
    };

    /**
     * Open map handler - opens Google Maps in new tab
     */
    const openMap = (koordinat) => {
      const lat = koordinat.lat || koordinat.latitude;
      const lng = koordinat.long || koordinat.longitude;
      window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
    };

    /**
     * Save response handler
     */
    const onSave = (res, med, rem, princ, ref) => {
      responseGear = res;
      mediaGear = med;
      remarkGear = rem;
      principalGear = princ;
      referenceGear = ref;

      console.log('----------', new Date(), '----------');
      console.log('Save - response:', responseGear);
      console.log('Save - media:', mediaGear);
      console.log('Save - remark:', remarkGear);
      console.log('Save - principal:', principalGear);
      console.log('Save - reference:', referenceGear);

      // Save to localStorage for persistence
      localStorage.setItem('formGear_response', JSON.stringify(responseGear));
      localStorage.setItem('formGear_media', JSON.stringify(mediaGear));
    };

    /**
     * Submit response handler
     */
    const onSubmit = (res, med, rem, princ, ref) => {
      responseGear = res;
      mediaGear = med;
      remarkGear = rem;
      principalGear = princ;
      referenceGear = ref;

      console.log('----------', new Date(), '----------');
      console.log('Submit - response:', responseGear);
      console.log('Submit - media:', mediaGear);
      console.log('Submit - remark:', remarkGear);
      console.log('Submit - principal:', principalGear);
      console.log('Submit - reference:', referenceGear);

      // Here you would typically send to your backend API
      alert('Form submitted! Check console for data.');
    };

    // =============================================================================
    // FORM INITIALIZATION
    // =============================================================================

    const loadFormData = async () => {
      const [reference, template, preset, response, validation, media, remark] = await Promise.all([
        fetch('./data/reference.json').then(res => res.json()).catch(() => ({})),
        fetch('./data/template.json').then(res => res.json()).catch(() => ({})),
        fetch('./data/preset.json').then(res => res.json()).catch(() => ({})),
        fetch('./data/response.json').then(res => res.json()).catch(() => ({})),
        fetch('./data/validation.json').then(res => res.json()).catch(() => ({})),
        fetch('./data/media.json').then(res => res.json()).catch(() => ({})),
        fetch('./data/remark.json').then(res => res.json()).catch(() => ({}))
      ]);

      return { reference, template, preset, response, validation, media, remark };
    };

    const initForm = async () => {
      const { reference, template, preset, response, validation, media, remark } = await loadFormData();

      // Create form using new API
      formInstance = createFormGear({
        data: {
          reference,
          template,
          preset,
          response,
          validation,
          media,
          remark
        },
        config: {
          clientMode: ClientMode.CAWI,
          formMode: FormMode.OPEN,
          initialMode: InitialMode.ASSIGN,
          lookupMode: LookupMode.ONLINE,
          username: 'adty',
          token: '',
          baseUrl: '',
          lookupKey: 'keys',
          lookupValue: 'values'
        },
        mobileHandlers: {
          uploadHandler,
          gpsHandler,
          offlineSearch,
          onlineSearch,
          exitHandler,
          openMap
        },
        callbacks: {
          onSave,
          onSubmit
        }
      });

      console.log('FormGear 2.0 CAWI initialized');

      // Expose form instance globally for debugging
      window.formGear = formInstance;
    };

    // Initialize form
    initForm();

  </script>
</body>

</html>